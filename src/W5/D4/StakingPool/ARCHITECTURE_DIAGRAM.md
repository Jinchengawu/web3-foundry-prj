# StakingPool 技术架构图

## 1. 系统整体架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户钱包      │    │  前端 DApp      │    │   区块链网络    │
│  (MetaMask)     │◄──►│  (Web界面)      │◄──►│   (Ethereum)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
                    ┌─────────────────────────────┐
                    │      StakingPool 合约      │
                    │      (核心业务逻辑)        │
                    └─────────────────────────────┘
                                │
                    ┌─────────────┼─────────────┐
                    │             │             │
                    ▼             ▼             ▼
        ┌─────────────────┐ ┌─────────────┐ ┌─────────────┐
        │   KK Token      │ │   借贷市场   │ │   安全模块   │
        │   (奖励代币)    │ │  (Aave等)   │ │ (权限管理)   │
        └─────────────────┘ └─────────────┘ └─────────────┘
```

## 2. 合约内部架构

```
┌─────────────────────────────────────────────────────────────┐
│                    KKStaking 合约                          │
├─────────────────────────────────────────────────────────────┤
│  状态变量 (State Variables)                                │
│  ├─ kkToken: IToken                                       │
│  ├─ lendingMarket: ILendingMarket                         │
│  ├─ totalStaked: uint256                                  │
│  ├─ accRewardPerShare: uint256                            │
│  └─ lastRewardTime: uint256                               │
├─────────────────────────────────────────────────────────────┤
│  用户数据映射 (User Data Mapping)                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ mapping(address => StakingInfo) stakingUsers       │   │
│  │                                                     │   │
│  │ struct StakingInfo {                                │   │
│  │   uint256 stakedAmount;                             │   │
│  │   uint256 rewardDebt;                               │   │
│  │   uint256 lastUpdateTime;                           │   │
│  │   uint256 lendingMarketBalance;                     │   │
│  │ }                                                   │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  核心功能函数 (Core Functions)                             │
│  ├─ stake() - 质押 ETH                                   │
│  ├─ unstake() - 解质押 ETH                               │
│  ├─ claim() - 领取奖励                                   │
│  ├─ balanceOf() - 查询质押余额                           │
│  └─ earned() - 查询待领取奖励                            │
├─────────────────────────────────────────────────────────────┤
│  内部辅助函数 (Internal Helper Functions)                 │
│  ├─ _updateReward() - 更新奖励状态                       │
│  ├─ _pendingReward() - 计算待领取奖励                    │
│  ├─ _depositToLendingMarket() - 存入借贷市场             │
│  └─ _withdrawFromLendingMarket() - 从借贷市场提取        │
├─────────────────────────────────────────────────────────────┤
│  管理功能 (Admin Functions)                               │
│  ├─ setLendingMarket() - 设置借贷市场                    │
│  ├─ pause() / unpause() - 暂停/恢复合约                  │
│  └─ emergencyWithdraw() - 紧急提取                       │
├─────────────────────────────────────────────────────────────┤
│  安全修饰符 (Security Modifiers)                          │
│  ├─ nonReentrant - 防重入攻击                            │
│  ├─ whenNotPaused - 合约未暂停检查                       │
│  └─ onlyOwner - 仅所有者权限                             │
└─────────────────────────────────────────────────────────────┘
```

## 3. 数据流程图

### 3.1 质押流程
```
用户质押 ETH
    │
    ▼
┌─────────────────┐
│ 验证质押数量   │ ← require(msg.value > 0)
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 更新奖励状态   │ ← _updateReward()
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 更新用户信息   │ ← stakingUsers[msg.sender]
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 存入借贷市场   │ ← _depositToLendingMarket()
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 触发质押事件   │ ← emit Staked()
└─────────────────┘
```

### 3.2 奖励计算流程
```
时间流逝
    │
    ▼
┌─────────────────┐
│ 计算时间间隔   │ ← block.timestamp - lastRewardTime
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 计算总奖励     │ ← timePassed × REWARD_PER_BLOCK
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 更新累计奖励   │ ← accRewardPerShare += reward × 1e18 / totalStaked
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 更新最后时间   │ ← lastRewardTime = block.timestamp
└─────────────────┘
```

### 3.3 收益分配算法
```
用户质押信息
    │
    ▼
┌─────────────────┐
│ 获取质押数量   │ ← userInfo.stakedAmount
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 计算应得奖励   │ ← stakedAmount × accRewardPerShare / 1e18
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 减去奖励债务   │ ← - userInfo.rewardDebt
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 返回净奖励     │ ← return pendingReward
└─────────────────┘
```

## 4. 安全机制架构

```
┌─────────────────────────────────────────────────────────────┐
│                    安全防护层                               │
├─────────────────────────────────────────────────────────────┤
│  第一层：重入攻击防护                                      │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ modifier nonReentrant() {                           │   │
│  │   require(!_locked, "Reentrant call");              │   │
│  │   _locked = true;                                   │   │
│  │   _;                                                │   │
│  │   _locked = false;                                  │   │
│  │ }                                                   │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  第二层：权限控制                                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ modifier onlyOwner() {                              │   │
│  │   require(owner() == _msgSender(), "Not owner");    │   │
│  │   _;                                                │   │
│  │ }                                                   │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  第三层：状态检查                                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ modifier whenNotPaused() {                          │   │
│  │   require(!paused(), "Pausable: paused");           │   │
│  │   _;                                                │   │
│  │ }                                                   │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  第四层：输入验证                                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ require(msg.value > 0, "Amount must be > 0");      │   │
│  │ require(amount <= userInfo.stakedAmount, "Insufficient");│
│  │ require(address(_token) != address(0), "Invalid");  │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  第五层：安全转账                                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ (bool success, ) = payable(user).call{value: amount}("");│
│  │ require(success, "Transfer failed");                │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 5. 借贷市场集成架构

```
┌─────────────────────────────────────────────────────────────┐
│                借贷市场集成层                               │
├─────────────────────────────────────────────────────────────┤
│  接口抽象层                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ interface ILendingMarket {                          │   │
│  │   function deposit(uint256 amount) external payable;│   │
│  │   function withdraw(uint256 amount) external;       │   │
│  │   function balanceOf(address user) external view;   │   │
│  │   function getAPY() external view returns (uint256);│   │
│  │   function getInterest(address user) external view; │   │
│  │   function claimInterest(address user) external;    │   │
│  │ }                                                   │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  具体实现层                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Aave 协议集成                                        │   │
│  │ ├─ deposit() → aToken 铸造                          │   │
│  │ ├─ withdraw() → aToken 销毁                         │   │
│  │ └─ getAPY() → 动态利率查询                          │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Compound 协议集成                                    │   │
│  │ ├─ deposit() → cToken 铸造                          │   │
│  │ ├─ withdraw() → cToken 销毁                         │   │
│  │ └─ getAPY() → 算法利率查询                          │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  收益计算层                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 双重收益计算                                          │   │
│  │ ├─ 质押奖励 = 质押数量 × 时间 × 奖励率              │   │
│  │ ├─ 借贷利息 = 借贷余额 × 时间 × 借贷利率            │   │
│  │ └─ 总收益 = 质押奖励 + 借贷利息                     │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 6. 事件系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    事件系统                                 │
├─────────────────────────────────────────────────────────────┤
│  事件定义                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ event Staked(address indexed user, uint256 amount);│   │
│  │ event Unstaked(address indexed user, uint256 amount);│ │
│  │ event RewardClaimed(address indexed user, uint256 amount);│
│  │ event LendingMarketUpdated(address indexed oldMarket,   │
│  │                        address indexed newMarket);      │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  事件触发                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ stake() → emit Staked(msg.sender, msg.value);      │   │
│  │ unstake() → emit Unstaked(msg.sender, amount);     │   │
│  │ claim() → emit RewardClaimed(msg.sender, reward);  │   │
│  │ setLendingMarket() → emit LendingMarketUpdated();  │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  前端监听                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Web3.js / Ethers.js 事件监听                        │   │
│  │ ├─ 实时更新用户界面                                  │   │
│  │ ├─ 推送通知用户                                      │   │
│  │ └─ 记录操作历史                                      │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 7. 部署和升级架构

```
┌─────────────────────────────────────────────────────────────┐
│                  部署和升级策略                             │
├─────────────────────────────────────────────────────────────┤
│  部署流程                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 1. 部署 KK Token 合约                               │   │
│  │ 2. 部署 StakingPool 合约                            │   │
│  │ 3. 设置借贷市场地址                                 │   │
│  │ 4. 配置初始参数                                     │   │
│  │ 5. 进行安全测试                                     │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  升级策略                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 代理模式升级                                          │   │
│  │ ├─ 部署新的实现合约                                  │   │
│  │ ├─ 更新代理合约指向                                  │   │
│  │ ├─ 保持用户数据不变                                  │   │
│  │ └─ 支持功能扩展                                      │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  测试策略                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 单元测试                                              │   │
│  │ ├─ 功能测试                                          │   │
│  │ ├─ 边界条件测试                                      │   │
│  │ └─ 异常情况测试                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 集成测试                                              │   │
│  │ ├─ 合约间交互测试                                    │   │
│  │ ├─ 借贷市场集成测试                                  │   │
│  │ └─ 端到端流程测试                                    │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 8. 性能优化架构

```
┌─────────────────────────────────────────────────────────────┐
│                    性能优化策略                             │
├─────────────────────────────────────────────────────────────┤
│  Gas 优化                                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ├─ 使用 storage 引用减少 SLOAD 操作                │   │
│  │ ├─ 批量操作减少函数调用次数                        │   │
│  │ ├─ 优化循环和条件判断                              │   │
│  │ └─ 使用事件替代存储操作                            │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  计算优化                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ├─ 缓存计算结果避免重复计算                        │   │
│  │ ├─ 使用位移操作替代除法                            │   │
│  │ ├─ 优化数学公式减少计算步骤                        │   │
│  │ └─ 延迟计算到真正需要时                            │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│  存储优化                                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ├─ 紧凑的数据结构设计                              │   │
│  │ ├─ 使用 packed struct 节省存储空间                 │   │
│  │ ├─ 避免存储不必要的数据                            │   │
│  │ └─ 使用映射替代数组减少遍历                        │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

这个技术架构图全面展示了 StakingPool 合约的设计思路，包括系统架构、数据流程、安全机制、借贷市场集成、事件系统、部署策略和性能优化等方面。通过这些图表，可以更直观地理解整个系统的设计理念和技术实现。 